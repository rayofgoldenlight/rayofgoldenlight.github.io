<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Song Analysis Visualization</title>
<style>
  body { font-family: "Georgia", serif; margin: 0; padding: 20px; background: #fffdf8; color: #222; }
  h1, h2 { text-align: center; font-weight: normal; color: #222; }
  h1 { border-bottom: 2px solid #f0d879; padding-bottom: 10px; margin-bottom: 30px; }
  .container { max-width: 1000px; margin: auto; }
  .section { background: #ffffff; padding: 20px; margin: 20px 0; border-radius: 12px; border: 1px solid #e6e2d3; box-shadow: 2px 2px 6px rgba(0,0,0,0.05); }
  .section h2 { background: #fdf5d9; padding: 8px 12px; border-left: 4px solid #f0d879; border-radius: 6px; font-size: 1.2em; margin-bottom: 15px; }
  .collapsible { cursor: pointer; padding: 10px; border: none; outline: none; width: 100%; background: #f7f4ec; color: #222; border-radius: 6px; margin-bottom: 8px; text-align: left; font-weight: bold; transition: background 0.2s; }
  .collapsible:hover { background: #f0e9d2; }
  .content { display: none; padding-left: 10px; margin-top: 10px; }
  .score { font-weight: bold; font-size: 1.1em; color: #222; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95em; }
  td, th { border: 1px solid #ddd; padding: 6px 10px; text-align: left; }
  th { background: #fdf5d9; font-weight: normal; color: #333; }
  .bar { background: #f7f4ec; border-radius: 6px; overflow: hidden; margin: 4px 0; height: 12px; }
  .bar-fill { height: 100%; background: #f0d879; width: 0; transition: width 1s ease-out; }
  .timeline { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; }
  .chord-block { background: #fdf5d9; border: 1px solid #f0d879; padding: 10px 14px; border-radius: 10px; box-shadow: 2px 2px 4px rgba(0,0,0,0.05); flex: 0 0 auto; text-align: center; }
  .chord-name { font-size: 1em; color: #111; }
  .chord-time { font-size: 0.8em; color: #555; margin-top: 2px; }
  #inputArea { margin-bottom: 20px; text-align: center; }
  #jsonInput { width: 100%; height: 200px; font-family: monospace; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
  #renderBtn { margin-top: 10px; padding: 10px 20px; font-size: 1em; border: none; background: #f0d879; border-radius: 8px; cursor: pointer; }
  #renderBtn:hover { background: #e8c95e; }
</style>
</head>
<body>
<div class="container">
  <h1>Song Analysis: <span id="fileName"></span></h1>

  <div id="inputArea">
    <p>Paste your JSON song analysis here:</p>
    <textarea id="jsonInput" placeholder='{"file":"mysong.mp3", ...}'></textarea><br>
    <button id="renderBtn">Render Analysis</button>
  </div>

  <!-- Sections -->
  <div class="section" id="geniusScore"><h2>Genius Score</h2><div id="geniusContent"></div></div>
  <div class="section" id="basicStats"><h2>Basic Stats</h2><div id="basicStatsContent"></div></div>
  <div class="section" id="features"><h2>Features</h2><div id="featuresContent"></div></div>
  <div class="section" id="rhythm"><h2>Rhythm</h2><div id="rhythmContent"></div></div>
  <div class="section" id="harmony"><h2>Harmony</h2><div id="harmonyContent"></div></div>
  <div class="section" id="melody"><h2>Melody</h2><div id="melodyContent"></div></div>
  <div class="section" id="structure"><h2>Structure</h2><div id="structureContent"></div></div>
  <div class="section" id="production"><h2>Production</h2><div id="productionContent"></div></div>
  <div class="section" id="psychoacoustics"><h2>Psychoacoustics</h2><div id="psychoContent"></div></div>
</div>

<script>
function renderTable(obj) {
  let html = "<table>";
  for (let key in obj) {
    let val = obj[key];
    if (Array.isArray(val) && val.length > 0 && typeof val[0] === "object") {
      val = val.map(v => JSON.stringify(v)).join("<br>");
    } else if (typeof val === "object" && val !== null) {
      val = JSON.stringify(val);
    }
    html += `<tr><th>${key}</th><td>${val}</td></tr>`;
  }
  html += "</table>";
  return html;
}

function renderAnalysis(data) {
  document.getElementById("fileName").innerText = data.file || "Unknown";

  // Genius
  let geniusHtml = `
    <p>Overall Score: <span class="score">${data.genius.overall_score}</span></p>
    <div class="bar"><div class="bar-fill" style="width:${data.genius.overall_score}%"></div></div>
    <p>Is Genius: ${data.genius.is_genius ? "Yes" : "No"}</p>
    <p>Confidence: ${data.genius.confidence}</p>
  `;
  geniusHtml += "<h4>Category Scores</h4><table>";
  for (let cat in data.genius.categories) {
    if (cat === "explanation") continue;
    geniusHtml += `<tr><th>${cat}</th><td>
      <div class="bar"><div class="bar-fill" style="width:${data.genius.categories[cat]}%"></div></div>
      ${data.genius.categories[cat]}
    </td></tr>`;
  }
  geniusHtml += "</table>";
  geniusHtml += "<h4>Explanation</h4>";
  geniusHtml += "<b>Positive:</b> " + (data.genius.categories.explanation?.positive_contributors.join(", ") || "None") + "<br>";
  geniusHtml += "<b>Negative:</b> " + (data.genius.categories.explanation?.negative_contributors.join(", ") || "None");
  document.getElementById("geniusContent").innerHTML = geniusHtml;

  // Other sections
  document.getElementById("basicStatsContent").innerHTML = renderTable(data.basic_stats || {});
  
  // Features + MFCC styling
  if (data.features) {
    const f = data.features;
    let fHtml = `<table>
      <tr><th>Tempo (BPM)</th><td>${f.tempo_bpm}</td></tr>
      <tr><th>Key</th><td>${f.key}</td></tr>
      <tr><th>Spectral</th><td>
        <table style="width:100%; margin-top:8px;">
          <tr><th>Centroid</th><td>${f.spectral.centroid.toFixed(2)}</td></tr>
          <tr><th>Rolloff</th><td>${f.spectral.rolloff.toFixed(2)}</td></tr>
          <tr><th>Brightness</th><td>${f.spectral.brightness.toFixed(4)}</td></tr>
          <tr><th>MFCC</th><td>
            <div style="display:grid; grid-template-columns: repeat(auto-fill,minmax(60px,1fr)); gap:6px;">
              ${f.spectral.mfcc.map((val,i)=>`
                <div style="background:${val>=0?'#fff9e6':'#ffe6e6'};border:1px solid #ddd;border-radius:4px;padding:6px;text-align:center;">
                  C${i+1}<br><b>${val.toFixed(2)}</b>
                </div>`).join("")}
            </div>
          </td></tr>
        </table>
      </td></tr>
    </table>`;
    document.getElementById("featuresContent").innerHTML = fHtml;
  }

  document.getElementById("rhythmContent").innerHTML = renderTable(data.rhythm || {});
  //harmony section
const harmony = data.harmony;
let harmonyHtml = "<table>";
harmonyHtml += `<tr><th>Global Key</th><td>${harmony.global_key}</td></tr>`;
harmonyHtml += `<tr><th>Key Stability</th><td>${harmony.key_stability}</td></tr>`;
harmonyHtml += `<tr><th>Modulation Count</th><td>${harmony.modulation_count}</td></tr>`;
harmonyHtml += `<tr><th>Harmonic Motion</th><td>${harmony.harmonic_motion}</td></tr>`;
harmonyHtml += `<tr><th>Tension</th><td>${harmony.tension}</td></tr>`;

harmonyHtml += `<tr><th>Chord Progression</th><td><div class="timeline">`;

// Show chord + time
harmony.chords.forEach(ch => {
  harmonyHtml += `
    <div class="chord-block">
      <div class="chord-name">${ch.name}</div>
      <div class="chord-time">${ch.time_sec.toFixed(2)}s</div>
    </div>
  `;
});

harmonyHtml += `</div></td></tr></table>`;
document.getElementById("harmonyContent").innerHTML = harmonyHtml;
  document.getElementById("melodyContent").innerHTML = renderTable(data.melody || {});
  //structures section
  const structure = data.structure;
    let structureHtml = "<table>";
    structureHtml += `<tr><th>Section Count</th><td>${structure.section_count}</td></tr>`;
    structureHtml += `<tr><th>Arc Complexity</th><td>${structure.arc_complexity}</td></tr>`;
    structureHtml += `<tr><th>Repetition Ratio</th><td>${structure.repetition_ratio}</td></tr>`;
    structureHtml += `<tr><th>Duration Ratio</th><td>${structure.duration_ratio}</td></tr>`;
    structureHtml += `<tr><th>Has Chorus</th><td>${structure.has_chorus ? "Yes" : "No"}</td></tr>`;

    // Section Labels Summary
    structureHtml += `<tr><th>Labels Summary</th><td>
    <table style="border-collapse: collapse; width: 100%; margin-top: 8px;">
        <tr>
        <th style="text-align:left; padding: 6px; border-bottom: 1px solid #eee;">Label</th>
        <th style="text-align:left; padding: 6px; border-bottom: 1px solid #eee;">Count</th>
        </tr>`;
    for (const [label, count] of Object.entries(structure.section_labels_summary)) {
    structureHtml += `
        <tr>
        <td style="padding: 6px;">${label}</td>
        <td style="padding: 6px;">${count}</td>
        </tr>`;
    }
    structureHtml += `</table></td></tr>`;

    // Sections table
    structureHtml += `<tr><th>Sections</th><td>
    <table style="border-collapse: collapse; width: 100%; margin-top: 8px;">
        <tr>
        <th style="text-align:left; padding: 6px; border-bottom: 1px solid #eee;">Start (s)</th>
        <th style="text-align:left; padding: 6px; border-bottom: 1px solid #eee;">End (s)</th>
        <th style="text-align:left; padding: 6px; border-bottom: 1px solid #eee;">Duration</th>
        <th style="text-align:left; padding: 6px; border-bottom: 1px solid #eee;">Label</th>
        </tr>`;

    structure.sections.forEach(sec => {
    const duration = (sec.end_sec - sec.start_sec).toFixed(2);
    structureHtml += `
        <tr>
        <td style="padding: 6px;">${sec.start_sec.toFixed(2)}</td>
        <td style="padding: 6px;">${sec.end_sec.toFixed(2)}</td>
        <td style="padding: 6px;">${duration}</td>
        <td style="padding: 6px;">${sec.label}</td>
        </tr>`;
    });

    structureHtml += `</table></td></tr></table>`;
    document.getElementById("structureContent").innerHTML = structureHtml;
  document.getElementById("productionContent").innerHTML = renderTable(data.production || {});
  document.getElementById("psychoContent").innerHTML = renderTable(data.psychoacoustics || {});
}

document.getElementById("renderBtn").addEventListener("click", () => {
  try {
    const jsonText = document.getElementById("jsonInput").value;
    const parsed = JSON.parse(jsonText);
    renderAnalysis(parsed);
  } catch (e) {
    alert("Invalid JSON: " + e.message);
  }
});
</script>
</body>
</html>
